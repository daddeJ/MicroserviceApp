# CORS, Environment Variables & Security Configuration

## Overview
This document defines centralized configuration for CORS policies, environment variables, roles, and authorization policies to be used across all microservices.

---

## 1. CORS (Cross-Origin Resource Sharing) Configuration

### 1.1 CORS Policy Definitions

#### Development CORS Policy
```csharp
public static class CorsConstants
{
    public const string DevelopmentPolicy = "DevelopmentCorsPolicy";
    public const string ProductionPolicy = "ProductionCorsPolicy";
    public const string RestrictedPolicy = "RestrictedCorsPolicy";
}
```

#### Development Policy Configuration
```
-> Policy Name: "DevelopmentCorsPolicy"
-> Allowed Origins:
    - http://localhost:3000
    - http://localhost:3001
    - http://localhost:4200
    - http://localhost:5173
    - http://127.0.0.1:3000
-> Allowed Methods:
    - GET
    - POST
    - PUT
    - PATCH
    - DELETE
    - OPTIONS
-> Allowed Headers:
    - Authorization
    - Content-Type
    - Accept
    - Origin
    - X-Requested-With
    - X-Custom-Header
-> Expose Headers:
    - X-Pagination
    - X-Total-Count
-> Allow Credentials: true
-> Max Age: 3600 seconds (1 hour)
```

#### Production Policy Configuration
```
-> Policy Name: "ProductionCorsPolicy"
-> Allowed Origins:
    - https://yourdomain.com
    - https://www.yourdomain.com
    - https://app.yourdomain.com
    - https://admin.yourdomain.com
-> Allowed Methods:
    - GET
    - POST
    - PUT
    - PATCH
    - DELETE
-> Allowed Headers:
    - Authorization
    - Content-Type
    - Accept
    - Origin
-> Expose Headers:
    - X-Pagination
    - X-Total-Count
-> Allow Credentials: true
-> Max Age: 7200 seconds (2 hours)
-> Require HTTPS: true
```

#### Restricted Policy Configuration (Admin Only)
```
-> Policy Name: "RestrictedCorsPolicy"
-> Allowed Origins:
    - https://admin.yourdomain.com
-> Allowed Methods:
    - GET
    - POST
    - PATCH
    - DELETE
-> Allowed Headers:
    - Authorization
    - Content-Type
-> Expose Headers:
    - X-Total-Count
-> Allow Credentials: true
-> Max Age: 1800 seconds (30 minutes)
-> Require HTTPS: true
```

### 1.2 CORS Implementation Flow

```
-> Read Environment Variable: ASPNETCORE_ENVIRONMENT
-> If Environment == "Development":
    -> Apply DevelopmentCorsPolicy
        -> Allow localhost origins
        -> Allow all standard HTTP methods
        -> Relaxed security for testing
-> If Environment == "Staging":
    -> Apply ProductionCorsPolicy
        -> Use staging domain origins
        -> Standard security measures
-> If Environment == "Production":
    -> Apply ProductionCorsPolicy
        -> Use production domain origins
        -> Strict security measures
        -> Require HTTPS
-> For Admin Endpoints:
    -> Apply RestrictedCorsPolicy
        -> Only admin domain allowed
        -> Limited methods
        -> Enhanced security
```

### 1.3 CORS Configuration Code Example

```csharp
public static IServiceCollection AddCorsConfiguration(
    this IServiceCollection services, 
    IConfiguration configuration)
{
    var environment = configuration["ASPNETCORE_ENVIRONMENT"];
    var allowedOrigins = configuration.GetSection("Cors:AllowedOrigins").Get<string[]>();
    
    services.AddCors(options =>
    {
        // Development Policy
        options.AddPolicy(CorsConstants.DevelopmentPolicy, builder =>
        {
            builder
                .WithOrigins(
                    "http://localhost:3000",
                    "http://localhost:3001",
                    "http://localhost:4200",
                    "http://localhost:5173",
                    "http://127.0.0.1:3000"
                )
                .AllowAnyMethod()
                .AllowAnyHeader()
                .AllowCredentials()
                .WithExposedHeaders("X-Pagination", "X-Total-Count")
                .SetPreflightMaxAge(TimeSpan.FromHours(1));
        });
        
        // Production Policy
        options.AddPolicy(CorsConstants.ProductionPolicy, builder =>
        {
            builder
                .WithOrigins(allowedOrigins ?? Array.Empty<string>())
                .WithMethods("GET", "POST", "PUT", "PATCH", "DELETE")
                .WithHeaders("Authorization", "Content-Type", "Accept", "Origin")
                .AllowCredentials()
                .WithExposedHeaders("X-Pagination", "X-Total-Count")
                .SetPreflightMaxAge(TimeSpan.FromHours(2))
                .RequireHttps();
        });
        
        // Restricted Policy (Admin)
        options.AddPolicy(CorsConstants.RestrictedPolicy, builder =>
        {
            var adminOrigin = configuration["Cors:AdminOrigin"];
            builder
                .WithOrigins(adminOrigin ?? "https://admin.yourdomain.com")
                .WithMethods("GET", "POST", "PATCH", "DELETE")
                .WithHeaders("Authorization", "Content-Type")
                .AllowCredentials()
                .WithExposedHeaders("X-Total-Count")
                .SetPreflightMaxAge(TimeSpan.FromMinutes(30))
                .RequireHttps();
        });
    });
    
    return services;
}
```

---

## 2. Centralized Environment Variables

### 2.1 Application Settings

#### General Application Configuration
```bash
# Application
ASPNETCORE_ENVIRONMENT=Development
APP_NAME=MicroservicesApp
APP_VERSION=1.0.0
API_BASE_URL=https://api.yourdomain.com
```

#### Service Ports
```bash
# Service Ports
USER_SERVICE_PORT=5001
AUTH_SERVICE_PORT=5002
LOGGER_SERVICE_PORT=5003
ADMIN_SERVICE_PORT=5004
```

### 2.2 Database Configuration

```bash
# Database - SQL Server
DB_HOST=localhost
DB_PORT=1433
DB_NAME=MicroservicesDB
DB_USER=sa
DB_PASSWORD=YourStrongPassword123!
DB_CONNECTION_STRING=Server=${DB_HOST},${DB_PORT};Database=${DB_NAME};User Id=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=True;

# Database - User Service
USER_SERVICE_DB=UserServiceDB
USER_SERVICE_CONNECTION_STRING=Server=${DB_HOST},${DB_PORT};Database=${USER_SERVICE_DB};User Id=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=True;

# Database - Auth Service
AUTH_SERVICE_DB=AuthServiceDB
AUTH_SERVICE_CONNECTION_STRING=Server=${DB_HOST},${DB_PORT};Database=${AUTH_SERVICE_DB};User Id=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=True;

# Database - Logger Service
LOGGER_SERVICE_DB=LoggerServiceDB
LOGGER_SERVICE_CONNECTION_STRING=Server=${DB_HOST},${DB_PORT};Database=${LOGGER_SERVICE_DB};User Id=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=True;
```

### 2.3 Redis Cache Configuration

```bash
# Redis Cache
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=YourRedisPassword123!
REDIS_CONNECTION_STRING=${REDIS_HOST}:${REDIS_PORT},password=${REDIS_PASSWORD},ssl=False,abortConnect=False

# Cache Configuration
CACHE_EXPIRATION_MINUTES=60
CACHE_SLIDING_EXPIRATION_MINUTES=30
USER_CACHE_EXPIRATION_MINUTES=120
TOKEN_CACHE_EXPIRATION_MINUTES=60
SESSION_CACHE_EXPIRATION_MINUTES=60
```

### 2.4 RabbitMQ Configuration

```bash
# RabbitMQ
RABBITMQ_HOST=localhost
RABBITMQ_PORT=5672
RABBITMQ_USERNAME=guest
RABBITMQ_PASSWORD=guest
RABBITMQ_VIRTUAL_HOST=/
RABBITMQ_CONNECTION_STRING=amqp://${RABBITMQ_USERNAME}:${RABBITMQ_PASSWORD}@${RABBITMQ_HOST}:${RABBITMQ_PORT}/${RABBITMQ_VIRTUAL_HOST}

# RabbitMQ Queues
QUEUE_USER_REGISTERED=user.registered
QUEUE_USER_LOGIN=user.login
QUEUE_SESSION_REVOKED=session.revoked
QUEUE_SESSION_EXPIRED=session.expired

# RabbitMQ Exchanges
EXCHANGE_USER_EVENTS=user.events
EXCHANGE_AUTH_EVENTS=auth.events
EXCHANGE_LOG_EVENTS=log.events
```

### 2.5 JWT Configuration

```bash
# JWT Settings
JWT_SECRET_KEY=YourSuperSecretKeyThatIsAtLeast32CharactersLong!
JWT_ISSUER=https://yourdomain.com
JWT_AUDIENCE=https://yourdomain.com
JWT_EXPIRATION_MINUTES=60
JWT_REFRESH_TOKEN_EXPIRATION_DAYS=7
JWT_CLOCK_SKEW_MINUTES=5
```

### 2.6 CORS Configuration

```bash
# CORS Settings
CORS_ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com,https://app.yourdomain.com
CORS_ADMIN_ORIGIN=https://admin.yourdomain.com
CORS_ALLOW_CREDENTIALS=true
CORS_MAX_AGE_SECONDS=7200
```

### 2.7 Rate Limiting Configuration

```bash
# Rate Limiting
RATE_LIMIT_ENABLED=true
RATE_LIMIT_REQUESTS_PER_MINUTE=20
RATE_LIMIT_REQUESTS_PER_HOUR=100
RATE_LIMIT_REQUESTS_PER_DAY=1000
RATE_LIMIT_IP_WHITELIST=127.0.0.1,::1
```

### 2.8 Logging Configuration

```bash
# Logging
LOG_LEVEL=Information
LOG_TO_CONSOLE=true
LOG_TO_FILE=true
LOG_FILE_PATH=/logs/app.log
LOG_FILE_MAX_SIZE_MB=100
LOG_FILE_RETENTION_DAYS=30

# Serilog (Optional)
SERILOG_MINIMUM_LEVEL=Information
SERILOG_SEQ_SERVER_URL=http://localhost:5341
SERILOG_SEQ_API_KEY=YourSeqApiKey
```

### 2.9 Email Configuration (Optional)

```bash
# Email Service
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=noreply@yourdomain.com
SMTP_PASSWORD=YourEmailPassword
SMTP_ENABLE_SSL=true
EMAIL_FROM=noreply@yourdomain.com
EMAIL_FROM_NAME=YourApp
```

### 2.10 External Services

```bash
# External APIs
EXTERNAL_API_BASE_URL=https://api.external-service.com
EXTERNAL_API_KEY=YourExternalApiKey
EXTERNAL_API_TIMEOUT_SECONDS=30
```

### 2.11 Security Configuration

```bash
# Security
ENCRYPTION_KEY=YourEncryptionKeyHere32Chars!!
ENCRYPTION_IV=YourIVHere16Char
REQUIRE_HTTPS=true
ENABLE_HSTS=true
HSTS_MAX_AGE_SECONDS=31536000
```

---

## 3. Roles and Permissions

### 3.1 Role Definitions

```csharp
public static class Roles
{
    public const string SuperAdmin = "SuperAdmin";
    public const string Admin = "Admin";
    public const string Moderator = "Moderator";
    public const string User = "User";
    public const string Guest = "Guest";
}
```

### 3.2 Role Hierarchy

```
SuperAdmin (Level 5)
    └── Admin (Level 4)
        └── Moderator (Level 3)
            └── User (Level 2)
                └── Guest (Level 1)
```

### 3.3 Role Descriptions

#### SuperAdmin
```
-> Full system access
-> Can manage all users
-> Can manage all roles
-> Can access all admin endpoints
-> Can view all logs and analytics
-> Can revoke any session
-> Can modify system configuration
-> Tier Access: All (1-5)
```

#### Admin
```
-> Can manage users (except SuperAdmins)
-> Can view analytics and reports
-> Can access admin dashboard
-> Can view logs
-> Can revoke user sessions
-> Cannot modify SuperAdmin users
-> Tier Access: 1-4
```

#### Moderator
```
-> Can view user information
-> Can lock/unlock user accounts
-> Limited access to analytics
-> Can view basic logs
-> Cannot delete users
-> Cannot modify roles
-> Tier Access: 1-3
```

#### User
```
-> Standard user access
-> Can access own profile
-> Can update own information
-> Can view own sessions
-> Can logout own sessions
-> Tier Access: 1
```

#### Guest
```
-> Limited read-only access
-> Can view public content
-> Cannot modify any data
-> Temporary access
-> Tier Access: 1
```

---

## 4. Authorization Policies

### 4.1 Policy Definitions

```csharp
public static class Policies
{
    // Admin Policies
    public const string SuperAdminOnly = "SuperAdminOnly";
    public const string AdminOnly = "AdminOnly";
    public const string AdminOrModerator = "AdminOrModerator";
    
    // User Policies
    public const string AuthenticatedUser = "AuthenticatedUser";
    public const string UserOrAbove = "UserOrAbove";
    
    // Feature Policies
    public const string CanManageUsers = "CanManageUsers";
    public const string CanViewLogs = "CanViewLogs";
    public const string CanRevokeSessions = "CanRevokeSessions";
    public const string CanViewAnalytics = "CanViewAnalytics";
    public const string CanModifyRoles = "CanModifyRoles";
    
    // Tier Policies
    public const string Tier1Access = "Tier1Access";
    public const string Tier2Access = "Tier2Access";
    public const string Tier3Access = "Tier3Access";
    public const string Tier4Access = "Tier4Access";
    public const string Tier5Access = "Tier5Access";
}
```

### 4.2 Policy Configuration

#### SuperAdminOnly Policy
```
-> Policy Name: "SuperAdminOnly"
-> Requirements:
    - User must be authenticated
    - User must have role: SuperAdmin
-> Usage:
    - System configuration
    - Manage all users
    - Critical operations
```

#### AdminOnly Policy
```
-> Policy Name: "AdminOnly"
-> Requirements:
    - User must be authenticated
    - User must have role: Admin OR SuperAdmin
-> Usage:
    - User management
    - View analytics
    - Access admin dashboard
```

#### AdminOrModerator Policy
```
-> Policy Name: "AdminOrModerator"
-> Requirements:
    - User must be authenticated
    - User must have role: Admin OR SuperAdmin OR Moderator
-> Usage:
    - View user information
    - Basic moderation tasks
```

#### CanManageUsers Policy
```
-> Policy Name: "CanManageUsers"
-> Requirements:
    - User must be authenticated
    - User must have role: Admin OR SuperAdmin
    - User must have claim: "Permission" = "ManageUsers"
-> Usage:
    - Create users
    - Update users
    - Delete users
```

#### CanViewLogs Policy
```
-> Policy Name: "CanViewLogs"
-> Requirements:
    - User must be authenticated
    - User must have role: Admin OR SuperAdmin OR Moderator
    - User must have claim: "Permission" = "ViewLogs"
-> Usage:
    - Access log endpoints
    - View log analytics
```

#### CanRevokeSessions Policy
```
-> Policy Name: "CanRevokeSessions"
-> Requirements:
    - User must be authenticated
    - User must have role: Admin OR SuperAdmin
    - User must have claim: "Permission" = "RevokeSessions"
-> Usage:
    - Revoke user sessions
    - Force logout users
```

#### CanViewAnalytics Policy
```
-> Policy Name: "CanViewAnalytics"
-> Requirements:
    - User must be authenticated
    - User must have role: Admin OR SuperAdmin
    - User must have claim: "Permission" = "ViewAnalytics"
-> Usage:
    - View dashboard analytics
    - Access reports
```

#### CanModifyRoles Policy
```
-> Policy Name: "CanModifyRoles"
-> Requirements:
    - User must be authenticated
    - User must have role: SuperAdmin
    - User must have claim: "Permission" = "ModifyRoles"
-> Usage:
    - Assign roles to users
    - Remove roles from users
```

#### Tier-Based Policies
```
-> Policy Name: "Tier1Access"
-> Requirements:
    - User must be authenticated
    - User must have claim: "Tier" >= 1

-> Policy Name: "Tier2Access"
-> Requirements:
    - User must be authenticated
    - User must have claim: "Tier" >= 2

-> Policy Name: "Tier3Access"
-> Requirements:
    - User must be authenticated
    - User must have claim: "Tier" >= 3

-> Policy Name: "Tier4Access"
-> Requirements:
    - User must be authenticated
    - User must have claim: "Tier" >= 4

-> Policy Name: "Tier5Access"
-> Requirements:
    - User must be authenticated
    - User must have claim: "Tier" = 5
-> Usage:
    - Feature gating
    - Access to premium features
```

### 4.3 Policy Implementation Code

```csharp
public static IServiceCollection AddAuthorizationPolicies(
    this IServiceCollection services)
{
    services.AddAuthorization(options =>
    {
        // Role-Based Policies
        options.AddPolicy(Policies.SuperAdminOnly, policy =>
            policy.RequireRole(Roles.SuperAdmin));
        
        options.AddPolicy(Policies.AdminOnly, policy =>
            policy.RequireRole(Roles.Admin, Roles.SuperAdmin));
        
        options.AddPolicy(Policies.AdminOrModerator, policy =>
            policy.RequireRole(Roles.Admin, Roles.SuperAdmin, Roles.Moderator));
        
        options.AddPolicy(Policies.AuthenticatedUser, policy =>
            policy.RequireAuthenticatedUser());
        
        options.AddPolicy(Policies.UserOrAbove, policy =>
            policy.RequireRole(Roles.User, Roles.Moderator, Roles.Admin, Roles.SuperAdmin));
        
        // Permission-Based Policies
        options.AddPolicy(Policies.CanManageUsers, policy =>
        {
            policy.RequireRole(Roles.Admin, Roles.SuperAdmin);
            policy.RequireClaim("Permission", "ManageUsers");
        });
        
        options.AddPolicy(Policies.CanViewLogs, policy =>
        {
            policy.RequireRole(Roles.Admin, Roles.SuperAdmin, Roles.Moderator);
            policy.RequireClaim("Permission", "ViewLogs");
        });
        
        options.AddPolicy(Policies.CanRevokeSessions, policy =>
        {
            policy.RequireRole(Roles.Admin, Roles.SuperAdmin);
            policy.RequireClaim("Permission", "RevokeSessions");
        });
        
        options.AddPolicy(Policies.CanViewAnalytics, policy =>
        {
            policy.RequireRole(Roles.Admin, Roles.SuperAdmin);
            policy.RequireClaim("Permission", "ViewAnalytics");
        });
        
        options.AddPolicy(Policies.CanModifyRoles, policy =>
        {
            policy.RequireRole(Roles.SuperAdmin);
            policy.RequireClaim("Permission", "ModifyRoles");
        });
        
        // Tier-Based Policies
        options.AddPolicy(Policies.Tier1Access, policy =>
            policy.RequireAssertion(context =>
                context.User.HasClaim(c => c.Type == "Tier" && int.Parse(c.Value) >= 1)));
        
        options.AddPolicy(Policies.Tier2Access, policy =>
            policy.RequireAssertion(context =>
                context.User.HasClaim(c => c.Type == "Tier" && int.Parse(c.Value) >= 2)));
        
        options.AddPolicy(Policies.Tier3Access, policy =>
            policy.RequireAssertion(context =>
                context.User.HasClaim(c => c.Type == "Tier" && int.Parse(c.Value) >= 3)));
        
        options.AddPolicy(Policies.Tier4Access, policy =>
            policy.RequireAssertion(context =>
                context.User.HasClaim(c => c.Type == "Tier" && int.Parse(c.Value) >= 4)));
        
        options.AddPolicy(Policies.Tier5Access, policy =>
            policy.RequireAssertion(context =>
                context.User.HasClaim(c => c.Type == "Tier" && int.Parse(c.Value) == 5)));
    });
    
    return services;
}
```

---

## 5. Claims Structure

### 5.1 Standard Claims

```csharp
public static class ClaimTypes
{
    public const string UserId = "UserId";
    public const string Email = "Email";
    public const string UserName = "UserName";
    public const string Role = "Role";
    public const string Tier = "Tier";
    public const string Permission = "Permission";
    public const string SessionId = "SessionId";
}
```

### 5.2 Permission Claims

```
ViewLogs
ManageUsers
RevokeSessions
ViewAnalytics
ModifyRoles
ModifySettings
ViewReports
ManageTiers
```

### 5.3 JWT Claims Example

```json
{
    "UserId": "123e4567-e89b-12d3-a456-426614174000",
    "Email": "admin@example.com",
    "UserName": "admin",
    "Role": ["Admin", "Moderator"],
    "Tier": "3",
    "Permission": ["ViewLogs", "ManageUsers", "ViewAnalytics"],
    "SessionId": "session-001",
    "iss": "https://yourdomain.com",
    "aud": "https://yourdomain.com",
    "exp": 1696944000,
    "nbf": 1696940400,
    "iat": 1696940400
}
```

---

## 6. Environment-Specific Configuration Files

### 6.1 appsettings.Development.json
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "AllowedHosts": "*",
  "CorsPolicy": "DevelopmentCorsPolicy",
  "RequireHttps": false,
  "DetailedErrors": true
}
```

### 6.2 appsettings.Production.json
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "AllowedHosts": "yourdomain.com,*.yourdomain.com",
  "CorsPolicy": "ProductionCorsPolicy",
  "RequireHttps": true,
  "DetailedErrors": false
}
```

---

## 7. Configuration Loading Flow

```
-> Application Startup
-> Load Base Configuration (appsettings.json)
-> Load Environment-Specific Configuration (appsettings.{Environment}.json)
-> Load Environment Variables
    -> Override appsettings with Environment Variables
-> Load User Secrets (Development Only)
-> Load Azure Key Vault / AWS Secrets Manager (Production)
-> Validate Required Configuration
    -> JWT_SECRET_KEY must exist
    -> Database connection strings must be valid
    -> Redis connection must be valid
    -> RabbitMQ connection must be valid
-> Build Configuration Object
-> Inject into Services
```

---

## 8. Best Practices

### 8.1 CORS
- Use restrictive policies in production
- Never use `AllowAnyOrigin()` with `AllowCredentials()`
- Specify exact origins in production
- Use environment variables for allowed origins
- Enable preflight caching to reduce OPTIONS requests

### 8.2 Environment Variables
- Never commit secrets to source control
- Use Azure Key Vault / AWS Secrets Manager in production
- Use User Secrets for local development
- Validate all required environment variables at startup
- Use strong, randomly generated secrets

### 8.3 Roles and Policies
- Follow principle of least privilege
- Use claims for fine-grained permissions
- Combine role-based and claims-based authorization
- Regularly audit role assignments
- Document all policies clearly

### 8.4 Security
- Rotate secrets regularly
- Use different secrets per environment
- Enable HTTPS in production
- Implement rate limiting
- Log all authentication and authorization failures
- Use strong password policies
- Enable MFA for admin accounts