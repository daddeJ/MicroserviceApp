# Unified API Response Structure

## Overview
This document defines the standardized API response format to be used across all microservices (UserService, AuthService, LoggerService, AdminService) to ensure consistency and improve client-side handling.

---

## 1. Core Response Models

### 1.1 ApiResponse<T>
```csharp
public class ApiResponse<T>
{
    public bool Success { get; set; }
    public string Message { get; set; }
    public T? Data { get; set; }
    public ErrorDetail? Error { get; set; }
    public DateTime Timestamp { get; set; } = DateTime.UtcNow;
    
    public static ApiResponse<T> Ok(T data, string? message = null) =>
        new() 
        { 
            Success = true, 
            Message = message ?? "Request successful", 
            Data = data 
        };
    
    public static ApiResponse<T> Fail(string message, ErrorDetail? error = null) =>
        new() 
        { 
            Success = false, 
            Message = message, 
            Error = error 
        };
    
    public static ApiResponse<T> Fail(string message, string errorCode) =>
        new() 
        { 
            Success = false, 
            Message = message, 
            Error = new ErrorDetail 
            { 
                ErrorCode = errorCode, 
                ErrorMessage = message 
            }
        };
}
```

### 1.2 ErrorDetail
```csharp
public class ErrorDetail
{
    public string ErrorCode { get; set; }
    public string ErrorMessage { get; set; }
    public string? StackTrace { get; set; }
    public Dictionary<string, string[]>? ValidationErrors { get; set; }
}
```

### 1.3 PaginationMetadata
```csharp
public class PaginationMetadata
{
    public int TotalCount { get; set; }
    public int PageSize { get; set; }
    public int CurrentPage { get; set; }
    public int TotalPages => (int)Math.Ceiling(TotalCount / (double)PageSize);
    public bool HasPrevious => CurrentPage > 1;
    public bool HasNext => CurrentPage < TotalPages;
}
```

### 1.4 PagedApiResponse<T>
```csharp
public class PagedApiResponse<T> : ApiResponse<T>
{
    public PaginationMetadata Pagination { get; set; }
    
    public static PagedApiResponse<T> Ok(T data, PaginationMetadata pagination, string? message = null) =>
        new() 
        { 
            Success = true, 
            Message = message ?? "Request successful", 
            Data = data,
            Pagination = pagination
        };
}
```

---

## 2. Response Examples by Service

### 2.1 UserService Responses

#### Registration Success
```json
{
    "success": true,
    "message": "User registered successfully",
    "data": {
        "userDetail": {
            "id": "123e4567-e89b-12d3-a456-426614174000",
            "userName": "john_doe",
            "email": "john@example.com",
            "roles": ["User"],
            "tier": 1
        },
        "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "refreshToken": "def50200a1b2c3d4e5f6..."
    },
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Registration Failure - Validation Error
```json
{
    "success": false,
    "message": "Validation failed",
    "data": null,
    "error": {
        "errorCode": "VALIDATION_ERROR",
        "errorMessage": "One or more validation errors occurred",
        "stackTrace": null,
        "validationErrors": {
            "Email": ["Email is required", "Invalid email format"],
            "Password": ["Password must be at least 8 characters"]
        }
    },
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Login Success
```json
{
    "success": true,
    "message": "Login successful",
    "data": {
        "userDetail": {
            "id": "123e4567-e89b-12d3-a456-426614174000",
            "userName": "john_doe",
            "email": "john@example.com",
            "roles": ["User"],
            "tier": 1
        },
        "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "refreshToken": "def50200a1b2c3d4e5f6..."
    },
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Login Failure - Invalid Credentials
```json
{
    "success": false,
    "message": "Invalid username or password",
    "data": null,
    "error": {
        "errorCode": "INVALID_CREDENTIALS",
        "errorMessage": "The provided credentials are incorrect",
        "stackTrace": null,
        "validationErrors": null
    },
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Login Failure - User Locked
```json
{
    "success": false,
    "message": "Account is locked",
    "data": null,
    "error": {
        "errorCode": "USER_LOCKED",
        "errorMessage": "Your account has been locked. Please contact support.",
        "stackTrace": null,
        "validationErrors": null
    },
    "timestamp": "2025-10-10T10:30:00Z"
}
```

---

### 2.2 AuthService Responses

#### Get All Sessions Success
```json
{
    "success": true,
    "message": "Active sessions retrieved successfully",
    "data": [
        {
            "userId": "123e4567-e89b-12d3-a456-426614174000",
            "accessToken": "eyJh...xxxx",
            "refreshToken": "def5...xxxx",
            "issuedAt": "2025-10-10T10:00:00Z",
            "expiresAt": "2025-10-10T11:00:00Z",
            "deviceInfo": "Chrome 118.0 on Windows 10",
            "ipAddress": "192.168.1.100",
            "status": "Active"
        }
    ],
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Get Session Statistics Success
```json
{
    "success": true,
    "message": "Session statistics retrieved successfully",
    "data": {
        "activeSessionsCount": 1250,
        "loginsPerDay": 450,
        "loginsPerWeek": 3200,
        "loginsPerMonth": 12500,
        "tokenExpirationStats": {
            "expiredTokens": 340,
            "validTokens": 1250,
            "averageLifetimeMinutes": 60
        },
        "deviceDistribution": {
            "Chrome": 650,
            "Firefox": 300,
            "Safari": 200,
            "Edge": 100
        },
        "ipDistribution": {
            "192.168.1.0/24": 800,
            "10.0.0.0/24": 450
        }
    },
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Revoke Session Success
```json
{
    "success": true,
    "message": "Session revoked successfully",
    "data": {
        "affectedSessions": 1,
        "revokedAt": "2025-10-10T10:30:00Z"
    },
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Revoke Session Failure - Session Not Found
```json
{
    "success": false,
    "message": "Session not found",
    "data": null,
    "error": {
        "errorCode": "SESSION_NOT_FOUND",
        "errorMessage": "The specified session does not exist",
        "stackTrace": null,
        "validationErrors": null
    },
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Revoke All Sessions Success
```json
{
    "success": true,
    "message": "All user sessions revoked successfully",
    "data": {
        "totalRevokedSessions": 5,
        "revokedAt": "2025-10-10T10:30:00Z"
    },
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

---

### 2.3 LoggerService Responses

#### Get Logs Success (Paginated)
```json
{
    "success": true,
    "message": "Logs retrieved successfully",
    "data": [
        {
            "logId": "log-001",
            "userId": "123e4567-e89b-12d3-a456-426614174000",
            "eventType": "UserLogin",
            "service": "UserService",
            "message": "User logged in successfully",
            "timestamp": "2025-10-10T10:00:00Z",
            "ipAddress": "192.168.1.100",
            "deviceInfo": "Chrome 118.0 on Windows 10",
            "logLevel": "Information"
        }
    ],
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z",
    "pagination": {
        "totalCount": 1000,
        "pageSize": 50,
        "currentPage": 1,
        "totalPages": 20,
        "hasPrevious": false,
        "hasNext": true
    }
}
```

#### Get Log Statistics Success
```json
{
    "success": true,
    "message": "Log statistics retrieved successfully",
    "data": {
        "eventsPerDay": 450,
        "eventsPerWeek": 3200,
        "eventsPerMonth": 12500,
        "failedLoginAttempts": 45,
        "tokenGenerationPerService": {
            "UserService": 200,
            "AuthService": 200
        },
        "errorsPerService": {
            "UserService": 5,
            "AuthService": 3,
            "LoggerService": 1
        }
    },
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Search Logs Success
```json
{
    "success": true,
    "message": "Search completed successfully",
    "data": [
        {
            "logId": "log-042",
            "userId": "123e4567-e89b-12d3-a456-426614174000",
            "eventType": "FailedLogin",
            "service": "UserService",
            "message": "Login attempt failed - invalid password",
            "timestamp": "2025-10-10T09:45:00Z",
            "ipAddress": "192.168.1.105",
            "deviceInfo": "Firefox 119.0 on macOS",
            "logLevel": "Warning"
        }
    ],
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z",
    "pagination": {
        "totalCount": 25,
        "pageSize": 50,
        "currentPage": 1,
        "totalPages": 1,
        "hasPrevious": false,
        "hasNext": false
    }
}
```

#### Search Logs Failure - Invalid Date Range
```json
{
    "success": false,
    "message": "Invalid search criteria",
    "data": null,
    "error": {
        "errorCode": "INVALID_DATE_RANGE",
        "errorMessage": "End date must be after start date",
        "stackTrace": null,
        "validationErrors": {
            "DateRange": ["Invalid date range specified"]
        }
    },
    "timestamp": "2025-10-10T10:30:00Z"
}
```

---

### 2.4 AdminService Responses

#### Get Users Success (Paginated)
```json
{
    "success": true,
    "message": "Users retrieved successfully",
    "data": [
        {
            "id": "123e4567-e89b-12d3-a456-426614174000",
            "userName": "john_doe",
            "email": "john@example.com",
            "roles": ["User"],
            "tier": 1,
            "isLocked": false,
            "createdAt": "2025-09-01T00:00:00Z"
        }
    ],
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z",
    "pagination": {
        "totalCount": 500,
        "pageSize": 10,
        "currentPage": 1,
        "totalPages": 50,
        "hasPrevious": false,
        "hasNext": true
    }
}
```

#### Get User by ID Success
```json
{
    "success": true,
    "message": "User retrieved successfully",
    "data": {
        "id": "123e4567-e89b-12d3-a456-426614174000",
        "userName": "john_doe",
        "email": "john@example.com",
        "roles": ["User", "Moderator"],
        "tiers": [1, 2],
        "isLocked": false,
        "lockoutEnd": null,
        "createdAt": "2025-09-01T00:00:00Z",
        "lastLoginAt": "2025-10-10T09:00:00Z"
    },
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Get User by ID Failure - Not Found
```json
{
    "success": false,
    "message": "User not found",
    "data": null,
    "error": {
        "errorCode": "USER_NOT_FOUND",
        "errorMessage": "No user exists with the specified ID",
        "stackTrace": null,
        "validationErrors": null
    },
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Update User Success
```json
{
    "success": true,
    "message": "User updated successfully",
    "data": {
        "id": "123e4567-e89b-12d3-a456-426614174000",
        "updatedFields": ["email", "tier"],
        "updatedAt": "2025-10-10T10:30:00Z"
    },
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Update User Failure - Validation Error
```json
{
    "success": false,
    "message": "Update failed - validation errors",
    "data": null,
    "error": {
        "errorCode": "VALIDATION_ERROR",
        "errorMessage": "Invalid update data provided",
        "stackTrace": null,
        "validationErrors": {
            "Email": ["Invalid email format"],
            "Tier": ["Tier must be between 1 and 5"]
        }
    },
    "timestamp": "2025-10-10T10:30:00Z"
}
```

#### Delete User Success (Soft Delete)
```json
{
    "success": true,
    "message": "User deleted successfully",
    "data": {
        "id": "123e4567-e89b-12d3-a456-426614174000",
        "deletedAt": "2025-10-10T10:30:00Z",
        "deletionType": "SoftDelete"
    },
    "error": null,
    "timestamp": "2025-10-10T10:30:00Z"
}
```

---

## 3. Standard Error Codes

### 3.1 Authentication & Authorization Errors
```
AUTH_001 - INVALID_CREDENTIALS
AUTH_002 - TOKEN_EXPIRED
AUTH_003 - TOKEN_INVALID
AUTH_004 - UNAUTHORIZED_ACCESS
AUTH_005 - INSUFFICIENT_PERMISSIONS
AUTH_006 - SESSION_NOT_FOUND
AUTH_007 - SESSION_EXPIRED
AUTH_008 - SESSION_REVOKED
```

### 3.2 User Management Errors
```
USER_001 - USER_NOT_FOUND
USER_002 - USER_ALREADY_EXISTS
USER_003 - USER_LOCKED
USER_004 - USER_CREATION_FAILED
USER_005 - USER_UPDATE_FAILED
USER_006 - USER_DELETION_FAILED
```

### 3.3 Validation Errors
```
VAL_001 - VALIDATION_ERROR
VAL_002 - INVALID_INPUT
VAL_003 - REQUIRED_FIELD_MISSING
VAL_004 - INVALID_FORMAT
VAL_005 - INVALID_ROLE
VAL_006 - INVALID_TIER
VAL_007 - INVALID_DATE_RANGE
VAL_008 - INVALID_PAGINATION
```

### 3.4 System Errors
```
SYS_001 - INTERNAL_SERVER_ERROR
SYS_002 - DATABASE_ERROR
SYS_003 - CACHE_ERROR
SYS_004 - MESSAGE_QUEUE_ERROR
SYS_005 - EXTERNAL_SERVICE_ERROR
```

### 3.5 Rate Limiting Errors
```
RATE_001 - RATE_LIMIT_EXCEEDED
RATE_002 - TOO_MANY_REQUESTS
```

---

## 4. Response Flow Integration

### 4.1 UserService - Registration
```
-> Validate Input
    -> If validation fails:
        Return ApiResponse<object>.Fail(
            "Validation failed", 
            new ErrorDetail 
            { 
                ErrorCode = "VAL_001",
                ErrorMessage = "Validation failed",
                ValidationErrors = validationErrors
            }
        )
-> Create User
    -> If creation fails:
        Return ApiResponse<object>.Fail(
            "User creation failed",
            "USER_004"
        )
-> Process Registration
-> Return ApiResponse<AuthResponseDto>.Ok(
    new AuthResponseDto 
    {
        UserDetail = userDto,
        AccessToken = token,
        RefreshToken = refreshToken
    },
    "User registered successfully"
)
```

### 4.2 UserService - Login
```
-> Validate Input
    -> If validation fails:
        Return ApiResponse<object>.Fail(...)
-> Get User from DB
    -> If not found:
        Return ApiResponse<object>.Fail(
            "Invalid username or password",
            "AUTH_001"
        )
-> Verify Password
    -> If invalid:
        Return ApiResponse<object>.Fail(
            "Invalid username or password",
            "AUTH_001"
        )
-> Check if User Locked
    -> If locked:
        Return ApiResponse<object>.Fail(
            "Account is locked",
            "USER_003"
        )
-> Process Login
-> Return ApiResponse<AuthResponseDto>.Ok(
    new AuthResponseDto { ... },
    "Login successful"
)
```

### 4.3 AuthService - Get Sessions
```
-> Validate Request
    -> If validation fails:
        Return ApiResponse<object>.Fail(...)
-> Get Sessions from DB
-> Mask Sensitive Data
-> Return ApiResponse<List<SessionDto>>.Ok(
    sessions,
    "Active sessions retrieved successfully"
)
```

### 4.4 AuthService - Revoke Session
```
-> Validate Input
    -> If validation fails:
        Return ApiResponse<object>.Fail(...)
-> Find Session
    -> If not found:
        Return ApiResponse<object>.Fail(
            "Session not found",
            "AUTH_006"
        )
-> Revoke Session
-> Return ApiResponse<RevokeSessionResponseDto>.Ok(
    new RevokeSessionResponseDto 
    {
        AffectedSessions = 1,
        RevokedAt = DateTime.UtcNow
    },
    "Session revoked successfully"
)
```

### 4.5 LoggerService - Get Logs (Paginated)
```
-> Validate Pagination Parameters
    -> If validation fails:
        Return ApiResponse<object>.Fail(...)
-> Get Logs from DB with Pagination
-> Build Pagination Metadata
-> Return PagedApiResponse<List<LogDto>>.Ok(
    logs,
    new PaginationMetadata 
    {
        TotalCount = totalCount,
        PageSize = pageSize,
        CurrentPage = currentPage
    },
    "Logs retrieved successfully"
)
```

### 4.6 AdminService - Get Users (Paginated)
```
-> Validate Query Parameters
    -> If validation fails:
        Return ApiResponse<object>.Fail(...)
-> Query Users with Filters
-> Apply Pagination
-> Build Pagination Metadata
-> Return PagedApiResponse<List<UserDto>>.Ok(
    users,
    new PaginationMetadata { ... },
    "Users retrieved successfully"
)
```

### 4.7 AdminService - Update User
```
-> Validate UpdateUserDto
    -> If validation fails:
        Return ApiResponse<object>.Fail(...)
-> Get User by ID
    -> If not found:
        Return ApiResponse<object>.Fail(
            "User not found",
            "USER_001"
        )
-> Update User
    -> If update fails:
        Return ApiResponse<object>.Fail(
            "User update failed",
            "USER_005"
        )
-> Return ApiResponse<UpdateUserResponseDto>.Ok(
    new UpdateUserResponseDto 
    {
        Id = userId,
        UpdatedFields = updatedFields,
        UpdatedAt = DateTime.UtcNow
    },
    "User updated successfully"
)
```

### 4.8 AdminService - Delete User (Soft Delete)
```
-> Get User by ID
    -> If not found:
        Return ApiResponse<object>.Fail(
            "User not found",
            "USER_001"
        )
-> Soft Delete User
    -> If deletion fails:
        Return ApiResponse<object>.Fail(
            "User deletion failed",
            "USER_006"
        )
-> Return ApiResponse<DeleteUserResponseDto>.Ok(
    new DeleteUserResponseDto 
    {
        Id = userId,
        DeletedAt = DateTime.UtcNow,
        DeletionType = "SoftDelete"
    },
    "User deleted successfully"
)
```

---

## 5. Best Practices

### 5.1 Success Responses
- Always include meaningful success messages
- Provide relevant data in the `Data` property
- Use appropriate HTTP status codes (200, 201, 204)
- Include timestamp for tracking

### 5.2 Error Responses
- Use descriptive error messages
- Include error codes for client-side handling
- Don't expose sensitive information in error messages
- Only include stack traces in development environment
- Group validation errors by field

### 5.3 Pagination
- Always use `PagedApiResponse<T>` for paginated endpoints
- Include complete pagination metadata
- Provide `HasPrevious` and `HasNext` flags for UI navigation
- Validate page and size parameters

### 5.4 Consistency
- Use the same response structure across all services
- Maintain consistent naming conventions
- Use UTC timestamps
- Follow RESTful conventions for HTTP status codes

### 5.5 Security
- Never include sensitive data in error messages
- Mask tokens in responses (show only last 4 characters)
- Log security events separately
- Use generic messages for authentication failures

---

## 6. HTTP Status Code Mapping

```
200 OK - Successful GET, PATCH requests
201 Created - Successful POST requests (resource creation)
204 No Content - Successful DELETE requests
400 Bad Request - Validation errors, invalid input
401 Unauthorized - Missing or invalid authentication
403 Forbidden - Insufficient permissions
404 Not Found - Resource not found
409 Conflict - Resource already exists
429 Too Many Requests - Rate limit exceeded
500 Internal Server Error - Unexpected server errors
503 Service Unavailable - Service temporarily unavailable
```